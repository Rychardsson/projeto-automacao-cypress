name: 🚀 CI/CD - Cypress Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Job 1: Testes Cypress
  cypress-tests:
    name: 🧪 Cypress E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: 📦 Install Dependencies
        run: |
          npm ci
          npx cypress verify

      - name: 🗄️ Setup Database
        run: npm run setup

      - name: 🔍 Debug Environment
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Project files:"
          ls -la
          echo "Database file:"
          ls -la database.sqlite || echo "Database not found"

      - name: 🧪 Run Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          start: npm start
          wait-on: "http://localhost:3000"
          wait-on-timeout: 120
          browser: electron
          record: false
          spec: cypress/e2e/**/*.cy.js
        env:
          CYPRESS_baseUrl: http://localhost:3000

      - name: 📊 Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-results
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 7

      - name: 📈 Test Summary
        if: always()
        run: |
          echo "## 🧪 Cypress Test Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed. Check artifacts for details." >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Quality Checks
  quality-checks:
    name: 🔍 Quality Checks
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 🛡️ Security Audit
        run: npm audit --audit-level high || echo "⚠️ Security warnings found but not blocking"

      - name: 📊 Project Analysis
        run: |
          echo "## 📦 Project Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependencies**: $(npm list --depth=0 2>/dev/null | wc -l) packages" >> $GITHUB_STEP_SUMMARY
          echo "- **Project size**: $(du -sh . --exclude=node_modules | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Test files**: $(find cypress/e2e -name '*.cy.js' | wc -l) specs" >> $GITHUB_STEP_SUMMARY

  # Job 3: Build Status
  build-status:
    name: 📋 Build Status
    runs-on: ubuntu-latest
    needs: [cypress-tests, quality-checks]
    if: always()

    steps:
      - name: 📊 Final Summary
        run: |
          echo "## 🎯 CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🧪 Cypress Tests | ${{ needs.cypress-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 🔍 Quality Checks | ${{ needs.quality-checks.result == 'success' && '✅ Passed' || '⚠️ With Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Quick Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
