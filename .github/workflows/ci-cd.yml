name: ðŸš€ CI/CD - Cypress Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  cypress-tests:
    name: ðŸ§ª Cypress E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci
          npx cypress verify
          npx cypress version

      - name: ðŸ—„ï¸ Setup Database
        run: |
          npm run setup
          echo "âœ… Database setup completed"
          ls -la database.sqlite

      - name: ðŸ” Environment Debug
        run: |
          echo "=== System Information ==="
          echo "Node: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "OS: $(uname -a)"
          echo ""
          echo "=== Project Files ==="
          ls -la
          echo ""
          echo "=== Cypress Info ==="
          npx cypress info
          echo ""
          echo "=== Database Check ==="
          file database.sqlite || echo "Database file not found"

      - name: ðŸš€ Start Application Server
        run: |
          echo "ðŸŒ Starting server..."

          # Check if port 3000 is already in use
          if netstat -tlnp | grep :3000; then
            echo "âš ï¸ Port 3000 is already in use, killing existing process..."
            sudo kill -9 $(sudo lsof -t -i:3000) || echo "No process to kill"
          fi

          echo "ðŸ“‚ Checking database before starting server..."
          ls -la database.sqlite

          echo "ðŸš€ Starting Node.js server..."
          npm start &
          APP_PID=$!
          echo "ðŸ“ Server PID: $APP_PID"
          echo $APP_PID > /tmp/server.pid

          echo "â³ Waiting for server to initialize..."
          sleep 15

          echo "ðŸ” Testing server connectivity..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/test >/dev/null 2>&1; then
              echo "âœ… Server is responding at attempt $i"
              break
            else
              echo "âŒ Attempt $i/30 failed, retrying in 2s..."
              if [ $i -eq 15 ]; then
                echo "ðŸ” Mid-check diagnostics:"
                ps aux | grep node | head -5
                netstat -tlnp | grep :3000 || echo "Port 3000 not listening"
              fi
              sleep 2
            fi
          done

          echo "ðŸ§ª Final server test..."
          if curl -f http://localhost:3000/api/test; then
            echo "ðŸŽ‰ Server is ready for testing!"
          else
            echo "ðŸ’¥ ERROR: Server is not responding"
            echo "ðŸ” Final diagnostics:"
            echo "Process status:"
            ps aux | grep node | head -10
            echo "Network status:"
            netstat -tlnp | grep :3000 || echo "Port 3000 not listening"
            echo "Server logs (if any):"
            tail -20 /tmp/server.log 2>/dev/null || echo "No server logs found"
            exit 1
          fi

          echo "ðŸŽ‰ Server is ready for testing!"

      - name: ðŸ§ª Execute Cypress Tests
        run: |
          echo "ðŸš€ Starting Cypress test execution..."
          npx cypress run \
            --config baseUrl=http://localhost:3000 \
            --browser electron \
            --spec "cypress/e2e/**/*.cy.js" \
            --reporter spec \
            --reporter-options "verbose=true"
        env:
          CYPRESS_baseUrl: http://localhost:3000
          CYPRESS_defaultCommandTimeout: 10000
          CYPRESS_requestTimeout: 5000
          CYPRESS_responseTimeout: 30000

      - name: ï¿½ Cleanup Server
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            APP_PID=$(cat /tmp/server.pid)
            echo "ðŸ›‘ Stopping server (PID: $APP_PID)..."
            kill $APP_PID 2>/dev/null || echo "Server process already terminated"
            rm -f /tmp/server.pid
          else
            echo "âš ï¸ Server PID file not found"
          fi

      - name: ï¿½ðŸ“Š Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-test-results-${{ github.run_number }}
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 30

      - name: ðŸ“ˆ Test Results Summary
        if: always()
        run: |
          echo "## ðŸ§ª Cypress Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "All Cypress tests executed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FAILURE" >> $GITHUB_STEP_SUMMARY
            echo "Some tests failed. Check the artifacts for detailed screenshots and videos." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š Run Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Run Number: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY

  quality-audit:
    name: ðŸ” Security & Quality
    runs-on: ubuntu-latest
    needs: cypress-tests
    if: always()

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ›¡ï¸ Security Audit
        run: |
          echo "ðŸ” Running security audit..."
          npm audit --audit-level moderate || echo "âš ï¸ Security warnings detected but not blocking CI"

      - name: ðŸ“Š Project Metrics
        run: |
          echo "## ï¿½ Project Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependencies | $(npm list --depth=0 --json 2>/dev/null | jq '.dependencies | length' 2>/dev/null || echo 'N/A') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Test Files | $(find cypress/e2e -name '*.cy.js' | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Project Size | $(du -sh . --exclude=node_modules | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ Database Size | $(ls -lh database.sqlite 2>/dev/null | awk '{print $5}' || echo 'N/A') |" >> $GITHUB_STEP_SUMMARY

  final-status:
    name: ðŸ“‹ Pipeline Status
    runs-on: ubuntu-latest
    needs: [cypress-tests, quality-audit]
    if: always()

    steps:
      - name: ðŸ“Š Pipeline Summary
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Cypress Tests | ${{ needs.cypress-tests.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Quality Audit | ${{ needs.quality-audit.result == 'success' && 'âœ… PASSED' || 'âš ï¸ WITH WARNINGS' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.cypress-tests.result }}" == "success" ]]; then
            echo "### ðŸŽ‰ **PIPELINE STATUS: SUCCESS**" >> $GITHUB_STEP_SUMMARY
            echo "All tests passed! The application is ready for deployment. ðŸš€" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸš¨ **PIPELINE STATUS: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Tests failed. Please check the test artifacts and fix issues before merging. ðŸ”§" >> $GITHUB_STEP_SUMMARY
          fi
